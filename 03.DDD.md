#前言
之前我写过一篇关于DDD文章，大白话之辩论DDD，阿里面试中台化理解，这次心血来潮是因为最近在看掘金的一个关于领域设计的课程，然后下面谈谈我读后感，以及在我现实项目里面究竟用到哪些内容，最后还有今天看的美团的一篇 广告平台化的探索与实践，可以发现路子挺野的，因为我还没到那个层次能驾驭他这种设计方式，后面也会讲到，感兴趣的同学赶紧搬个椅子听听～

深入浅出 DDD就是这个课程，接下来我会大概讲下里面的内容，然后说下我的感受，最后谈谈我现在项目所做的领域改造，以及还有哪些缺陷需要改进。
课程内容
课程内容就是按照概念、然后分点举例子介绍，然后最后也有自己的demo，可以说适合小白入门的课程。但是属于入门级别的，明白我意思吗，深入一层在实际项目里面应用是如何的效果，究竟我项目哪些地方要做这样的改造，还是说全盘采用DDD理念，文章比较少钱探讨的。
我目前项目关于领域改造
我们项目从一开始就决定采用领域模式设计方式，当然也是第一次接触，有些概念是不太清晰的，下面大致讲下。首先我们采用经典四层的DDD架构，为什么呢？因为很多中间件基本是固定的，没有必要去依赖倒置，这种架构跟传统的mvc比较相似，接口层、应用层、领域层、基础设施层。
应用层一开始不理解，所以很薄的一层，后面的话明白是服务编排的作用，会做领域之间的编排。如果是那种直接一个领域搞定的，就通过领域服务处理即可。传统设计最复杂最多代码的就是服务实现类，虽然这个项目是按照领域来划分，但是没有去改变这个现状，所以导致实现类逻辑会杂。
顺下来，到dto跟中间转换，我们也是直接beanutils去复制参数，并没有采用防腐层那种去隔开，然后像数据库entity，ddd里面概念叫实体po，一般跟业务转换需要仓储层来转换，我们也是直接拿entity用，下面我再详细说这样做的原因。
对于外部http请求、rpc请求，采用防腐层acl去隔开，当然这里采用策略模式，不管是适配器模式还是什么模式，这里本质就是为了将系统跟外部隔开，就是系统需要什么东西，外部提供什么，而不是外部有什么我拿什么，减少强依赖。
类里面字段逻辑，还是采用贫血模型，受之前开发思路的影响。
缺陷

领域层逻辑很多，比较杂。

解决方案：按照业务包再分包，比如说商品领域，mybatis下面会有spu、sku、他们之间绑定关系，还有一些附加的东西，这些都是有自己servicImpl对吧，再加一个商品领域模型，这个抽出来一个模块，这就很清晰，哪个模块对应什么servicImpl，不然可能需要看代码注释半天才知道这是之前做过什么需求。

没有仓储层转换

A: 这个不算缺陷，我们采用mybatis-plus自带封装service，本身自带来很多基本crud，为啥你非要自己重写呢？其次没有做po跟业务类转换，原因是不可能一步到位，可能这个业务需要这个参数，另一个业务需要另一个参数，所以就是都给，按需自己在领域层处理

没有去实现值对象、实体、聚合根这些区分

A: 原因也很简单，目前阶段没有必要上到这个程度。有些扩展性要求很高的需求可以这么搞，比如我们公司基础服务里面有个商品服务，里面会经常变动字段，这时候就需要上这玩意了。值对象是不变的东西，实体是包含整个对象生命周期的字段还有字段逻辑。对于变动很大的需求就好办了，不变了可能就是商品code，对于spu、sku信息是会改变的，可以放在实体里头，有些新加一些额外的字段，比如优化价格，我们可以通过聚合类方式加上去，当我们不需要的时候，不会影响这些不变的内容，这是好处。
DDD思想（进阶）
核心思想
高内聚、低耦合，这个就是领域设计的核心思想。我们从架构上，比如说六边形架构，外层都是适配器，低耦合；比如应用层服务编排，也是为了隔开服务之间依赖，还是低耦合；防腐层是为了跟外部接口隔开，防止接口改动影响内部实现方式，也是低耦合；再到各层的转换，dto到业务bo，bo到po，层层转换，都是为了将他们隔开，字段不用全部输出，也是低耦合。
高内聚体现：采用充血模型，将字段的逻辑放在类里面，而不是在功能实现逻辑里头。这样的好处是什么呢？就是代码复用率，比如说a字段在逻辑b、c中都有，如果哪天需求变了，需要改动的地方一多就容易错，其次是提高代码复用率，也就是高内聚。
因需取材
我见过很多上来就是全套搬DDD的东西，有点为了技术而技术，作为研发人，我觉得应该理解为啥会有这种思想的出现，什么时候我们才需要去应用它，那我项目没有全盘采用算不算DDD呢？也算，就是我们下面要讲的什么情况下需要做这层改造。
讲讲架构东西，从一开始是单体服务，当业务上来之后，机器扛不住，需要横向还有纵向去提升整个系统服务能力，业务逻辑也会开始复杂起来，混乱不堪，这时开始有soa面向服务的治理，将这些功能按照业务模块来划分，分割成单独的机器，这样可以提高单独模块的服务能力；再到后来有了ddd领域设计思想，我觉得它是针对saas去做设计的，如果你按照paas去拆分了，其实没有所谓的再去定义领域了，这时会出现聚合层那些。对于saas里面会夹杂很多领域，如果整在一块会跟炒面一样混乱，ddd就是为了解决这个场景的。
什么时候要用到？
当系统业务已经复杂到影响开发，或者说一开始做项目的时候这个业务就是比较复杂，经常变动需求那种，就要这样设计。这让我想起之前面阿里的时候，面试官问我，mysql跟redis去区别是什么，什么时候要用redis？最后我去百度一下，mysql在200以上并发的时候性能越来越差，这时可以上redis。
同样的道理，我们需要观察系统里面的东西是否已经达到需要拆分的级别，而不是强行为了技术而技术。
举个栗子：
1、对于外部http请求，我们有个报单的功能，需要对n多家供应商，如果你在一个方法里面写，那就翘翘了，一直叠加上去。这时采用设计模块策略模式，根据供应商编号进行不同报单请求，这就是防腐层思路。
2、当领域层很多service，这时新人接手的时候上手很慢，你需要跟它讲什么表，什么类，这时我们再根据业务再分包，那就很清楚了。这个是不是高内聚体现，对于新人上手也是提效的，这才是有意义的。
3、对于各层转换，我们项目是没有做一层特殊处理的，直接逻辑里面转，原因是没有必要去隔开。因为我们很多逻辑都是直接复制两个类的字段，没有做复杂的逻辑处理，他们之间强耦合就强呗。但是对于一些公共方法，我们确实是可以这么做，因为避免各个方法都去重写逻辑，增加bug风险。
4、如果全套按照ddd去设计，可以去统计下代码量有多少，直接翻上去，对于打包cicd是有影响的，对开发也没有所谓的提效。

这就是我为什么说掘金那课程是初级，因需取材这方面没有展开太多。

美团的“野路子”

今天看到美团年度最佳文章展示，我看到里面一篇# 广告平台化的探索与实践，然后仔细阅读之后，觉得路子太野了，因为我驾驭不了。
它这一篇文章跟ddd很多思想是一致的，所以大家要用心的体会，而不是被浅层的皮毛所限制了思路。

大家想起什么了嘛，值对象、实体的思想，就是把不变、扩展的拆开。

这个是什么思想呢？模块化思想，流程化思想，这是对业务熟悉基础归纳出来的，也是工程师很重要的能力。模块化有多重要，比如说当你要改变东西的时候，我只需要加或者减少、或者变更模块即可，而不是像印度电线杆一样找半天都不知道需要改哪根电线。
路子很野的地方

首先这是什么？就是应用层的服务编排嘛，但是什么区别呢？它是在外部的，有点像聚合层，但是聚合层一般是一个服务去调其他服务整合数据，这个还能通过界面编排，老六了。我说个场景你就明白了，低代码平台，这是跟我做过一个项目很相似的。
里面也是接口编排，然后对结果进行处理，然后返回。有个我吐槽最多的，就是数据处理上比传统会麻烦，比如说我写段逻辑，可能java我很快就写完了，对于低代码平台我还要用js代码，golang代码处理，对于java开发同学是降效的，所以这块我不清楚美团是怎么去实现逻辑处理的，理论上也可以写java代码去整合不同模块数据。
这样做的意义
上面我们也提到了不要为了技术而去应用技术，美团这么做为了让pm、测试、研发都能直观知道广告业务里面有哪些策略，分别实现什么功能，特别是新人入手的时候，所以这里有个业务采集，对于已经实现的东西进行上报，qa同学也知道我需要测试的内容范围。
对于一般公司来设计： 就是新增一层聚合层，还无法实现调度引擎比较前沿的设计，当然对于一般公司已经够用了，所以说美团这样设计比较“野”，褒义词。






现状


当我们去看招聘网站的时候，会发现有些要求要会领域设计理念。还有些要求会SOA面向服务设计


在业务发展到一定体量，业务越来越复杂的时候，我们会发现很多的重复劳动，代码堆得像🚯一样，然后大家还在不断往里面丢代码（PS：这样对代码的可扩展性和维护带来很大的麻烦）


曾经一位小伙伴实现了更新某实体，然后记录操作日志的功能，由于很多方法都会更新到这个实体，他在每个方法里面都去记录修改的日志。这就埋下隐患 （⚠️ 你怎么保证别人在其他方法修改实体的时候，也能记录到操作日志呢，也就是太分散）


曾经面阿里国际化事业部的时候，被问了问题：你理解的中台化是什么？


大白话辩论
领域设计的作用
Q：针对第一点，不用领域设计行不行?
A：可以不用领域设计，在项目前期的时候，为了将业务快速跑起来，产生价值，这时是顾不上设计的合理性。而且当项目没有到一定的体量，是无法预知到未来会遇到什么变更。当然如果该系统一开始预估的体量就很大，在前期就需要严格去设计好整个架构。

Q：那什么时候需要用上呢？
A: 回到现状第二点，当业务发展到一定体量，业务复杂程度到达一定量的时候，需要用到领域设计来进行改造。这个时候你会发现，大量的代码重复copy，扩展性很差，每次新增需求的时候，都要不断重新开发，这时需要进行领域改造。

Q：第三点导致的原因是什么，怎么解决？
A：本质问题就是，每个方法都会影响到这个实体的更新，导致影响面很大，无法收集到一个点。我们的解决方法就是，将这些更新的地方，全部收集到一个方法里面，然后其他方法只是去调用该变更方法。这样实现日志记录，我只需要去监控一个方法即可！
DDD 精髓
还是大白话讲，就是高内聚，低耦合
PS :我见过很多人上来就是一堆理论，当然理论熟悉也是好事，这样执行起来有条理。
但是🤔 很多知识学到最后就是思想、逻辑、本质，其他都是它幻化出来的东西。这是比较玄学的，顺便讲下我的想法：虚的东西其实是在指引大的方向，比如说企业的愿景，你说它能给业务起作用吗？没有。它是为了给所有行动起到方向的意义。实的东西是为了落地，在落地的时候，又不是用虚的，这样就无法实施。
从实质去讲讲DDD


高内聚，低耦合

Q：为什么需要高内聚，低耦合呢？
我们可以看现状的第三点，其实就是他的变更方法扩散开来了，这样导致很多地方可以去修改方法。所以我们需要去将这些方法抽取到一个方法，这就是高内聚，我一个领域里面，它有什么功能，有什么属性，然后外界是没有这个领域有的功能
Q：低耦合又是啥？
举个常见的例子，A逻辑之后->B逻辑，那么问题来了，哪天我不用B逻辑，我要换C逻辑，但是B跟C我可以根据情况来切换。
有些大聪明站起来说：可以用策略模式。没错，但是它的本质是什么，就是低耦合。A是不知道B，也不知道C的具体实现，它只知道接口，具体它怎么实现，由适配器，什么规则去注入对应的实现类。
Q：既然低耦合的好处是什么？
为了可扩展性，当某天我不用某个中间件，而采用其他中间件，其实我只需要写另一个适配器就解决这个问题。如果代码跟其他中间件强耦合，那GG，你得去改写之前代码，随着中间件越来越多，代码的可读性也会越来越差。


我理解的中台化是什么？

🎄 中台化，SOA面向服务架构，其实都是一个思想，分而治之。一个服务里面，会有这个业务领域对应的相关操作，有对应领域模型，领域对象，值对象，上下文，然后对外提供服务，这体现高内聚，把对应的功能点收拢到一个服务里头进行管理。
🎃 中台概念里头，有个大前台，领域概念里头有个应用层。它作用是干嘛的？是做编排。就是我每个服务都有对应的功能，那么一个业务下来肯定会有很多不同服务来提供功能，需要一个地方来对他们进行编排。
Q：大前台的作用是什么？
在单体服务里头，我们通常写在service里面，像现状第三点，每个方法或者每个服务都有编排任务**，这样的话就有可能每个服务都会有重复的代码以及相似功能**，其实我们需要去抽象出来，变成一个单独的服务，这就是大前台

从理论上讲讲DDD

概念

领域：领域是相对于业务领域，或者问题域，范围概念。一个领域会包含多个子域，比如说订单域，会有商品、订单等等子域
限界上下文：既然有范围，那么就有边界，领域之间靠context上下文来进行通讯
实体、值对象：实体对应PO，值对象，在实体基础上会加上其他属性
聚合，聚合根：对实体、值对象会进行聚合，聚合根，可以通过这个访问内部实体的东西，不会直接操作跟内部实体
防腐层 ACL：限界上下文处理外界上下文的时候，需要做业务处理

贫血模型
里面只有属性，但是它的校验、属于它方法放在外面。违反单一原则，封装性比较差的
充血模型
里面包括属性，以及对应的方法实现。这样的好处，开闭原则，以后扩展的话在类里头新增方法。放在外面去做的话，其实是修改，应该减少修改的情况

Domain Primitive
在很多业务中，我们面向过程，比如说一个方法(String,String) 参数，他就会有前后顺序，分别代表什么
如果我们把它封装成对象的话，可以减少这样的问题。
原则

隐形概念显式化 ，比如说聚合根，对于一个东西，它有唯一的标识。如果是前者的话，可以是name，phone等等做标识
隐式上下文显式化
封装多对象

这就是为什么有很多值对象，聚合根，entity，其实是为了封装对应类，以及相关的方法，符合开闭原则
DDD分层

经典分层

接口层、应用层、领域层、基础层
接口层：面向接口，controller
Application  属于编排，就是其他层都封装各自小单元类，他们执行的顺序由应用层来处理
应用层：面向用例，就是会管理各个领域的调用关系，比如说校验完->A领域->B领域
领域层：有领域服务，以及对应子域。处理该领域的业务逻辑
基础层：处理数据库、缓存、第三方等等

六边形架构

概念上就是以适配器，来达到低耦合的效果，外界通过适配器访问内部接口，向内进行依赖
Q:向内依赖是什么？
越到底层，耦合越高，是我具体实现哪里，比如说我用到什么中间件，这里耦合是最高的。越到外面，就变成抽象接口，适配器，供外部去调用。

依赖倒置分层

基础设施层都是接口，而domain去实现对应接口功能。这样依赖的方向是向外，我用什么中间件，由domian层去解决注入什么类型。
Q：这样设计的好处是什么？
我们很多框架都强依赖第三方框架，比如说mybatis、mq等等中间件
那么它有什么坏处呢？就是当我换其他组件的时候，会改很多东西
domain层设计成接口的好处，就是具体实现不会强依赖其他组件，随时可以另外实现




















domain包含内容描述Repositity映射mapper以及扩展，避免强依赖底层ACL防腐层，处理跟外部不一样的东西，比如说协议、api、缓存
按照个人见解画的分层图


总结
DDD目的是为了高内聚，低耦合。它通过业务领域的划分，然后在领域里面实现对应的功能，实现高内聚。然后通过适配器，依赖倒置，实现低耦合。
在业务体量到达一定程度，还有业务复杂度比较高的项目，是有比较好的扩展性。
DDD的怎么实践？

DDD、Hexagonal、Onion、Clean、CQRS……我如何将它们组合在一起

觉得有帮助的，请关注下博主，感谢~🧧🧧🧧

作者：大鸡腿同学
链接：https://juejin.cn/post/7099492996244045831
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。



https://juejin.cn/post/7099492996244045831